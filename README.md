# ESP32 æ™ºèƒ½å·¥ä½ç›‘æ§ç³»ç»Ÿ

åŸºäº ESP32-S3 çš„æ™ºèƒ½å·¥ä½ç¯å¢ƒç›‘æµ‹ä¸æ§åˆ¶ç³»ç»Ÿï¼Œé›†æˆå¤šä¼ æ„Ÿå™¨æ•°æ®é‡‡é›†ã€RFIDé—¨ç¦æ§åˆ¶ã€OLEDæ˜¾ç¤ºå’ŒMQTTäº‘ç«¯é€šä¿¡åŠŸèƒ½ã€‚

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†ä¸€ä¸ªå®Œæ•´çš„æ™ºèƒ½å·¥ä½ç®¡ç†ç³»ç»Ÿï¼Œé€šè¿‡RFIDå¡ç‰‡æ§åˆ¶å·¥ä½è®¾å¤‡çš„å¼€å…³ï¼Œå®æ—¶ç›‘æµ‹ç¯å¢ƒå‚æ•°ï¼ˆæ¸©æ¹¿åº¦ã€å…‰ç…§ã€çƒŸé›¾ã€ç«ç„°ç­‰ï¼‰ï¼Œå¹¶é€šè¿‡MQTTåè®®å°†æ•°æ®ä¸Šä¼ è‡³äº‘å¹³å°ã€‚**å®Œå…¨å…¼å®¹OneNetç‰©æ¨¡å‹æ ‡å‡†**ã€‚

### æ ¸å¿ƒåŠŸèƒ½

- ğŸ” **RFIDé—¨ç¦æ§åˆ¶**ï¼šåˆ·å¡ä¸Šç­/ä¸‹ç­ï¼Œè‡ªåŠ¨å¼€å…³å·¥ä½ç”µæºå’Œç»§ç”µå™¨
- ğŸŒ¡ï¸ **ç¯å¢ƒç›‘æµ‹**ï¼šæ¸©æ¹¿åº¦ã€å…‰ç…§å¼ºåº¦ã€çƒŸé›¾æµ“åº¦ã€ç«ç„°æ£€æµ‹ã€çƒ­åº¦ç›‘æµ‹
- ğŸ“¡ **MQTTäº‘ç«¯é€šä¿¡**ï¼šå®æ—¶ä¸Šä¼ ä¼ æ„Ÿå™¨æ•°æ®åˆ°ç‰©è”ç½‘å¹³å°ï¼ˆOneNetæ ‡å‡†ï¼‰
- ğŸ–¥ï¸ **OLEDæ˜¾ç¤º**ï¼šæœ¬åœ°æ˜¾ç¤ºæ¸©æ¹¿åº¦å’ŒWiFiçŠ¶æ€
- âš¡ **ç»§ç”µå™¨æ§åˆ¶**ï¼šæ”¯æŒå¤šè·¯ç»§ç”µå™¨è®¾å¤‡æ§åˆ¶
- ğŸŒ **è¿œç¨‹æ§åˆ¶**ï¼šæ”¯æŒäº‘ç«¯è¿œç¨‹å¼€å…³è®¾å¤‡å’Œç”µæºç®¡ç†
- ğŸ“Š **æ— äººå€¼å®ˆç›‘æ§**ï¼šæœªåˆ·å¡æ—¶å®šæœŸä¸ŠæŠ¥åŸºç¡€ä¼ æ„Ÿå™¨æ•°æ®
- ğŸš¨ **ç´§æ€¥æ–­ç”µä¿æŠ¤**ï¼šä¼ æ„Ÿå™¨å¼‚å¸¸æ—¶è‡ªåŠ¨æ–­ç”µå¹¶ä¸ŠæŠ¥ç´§æ€¥äº‹ä»¶

---

## ğŸ”§ ç¡¬ä»¶é…ç½®

### å¼€å‘æ¿
- **ä¸»æ§èŠ¯ç‰‡**ï¼šESP32-S3

### ä¼ æ„Ÿå™¨æ¨¡å—ï¼ˆ6ä¸ªï¼‰

| ä¼ æ„Ÿå™¨ç±»å‹ | GPIOå¼•è„š | ADCé€šé“ | åŠŸèƒ½æè¿° |
|----------|---------|---------|---------|
| DHT11æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨ | GPIO 26 | - | æµ‹é‡ç¯å¢ƒæ¸©åº¦å’Œæ¹¿åº¦ |
| çƒ­æ•ä¼ æ„Ÿå™¨ | GPIO 34 | ADC1_CH6 | æ£€æµ‹ç¯å¢ƒçƒ­åº¦ |
| å…‰æ•ä¼ æ„Ÿå™¨ | GPIO 35 | ADC1_CH7 | æµ‹é‡å…‰ç…§å¼ºåº¦ |
| ç«ç„°ä¼ æ„Ÿå™¨ | GPIO 32 | ADC1_CH4 | æ£€æµ‹ç«ç„°ä¿¡å· |
| çƒŸé›¾ä¼ æ„Ÿå™¨ | GPIO 33 | ADC1_CH5 | æ£€æµ‹çƒŸé›¾æµ“åº¦ |
| äººä½“çº¢å¤–ä¼ æ„Ÿå™¨ | GPIO 36 | - | æ£€æµ‹äººä½“ç§»åŠ¨ |

### æ‰§è¡Œå™¨ï¼ˆ4è·¯ç»§ç”µå™¨ï¼‰

| æ‰§è¡Œå™¨åç§° | GPIOå¼•è„š | åŠŸèƒ½æè¿° |
|----------|---------|---------|
| ç”µæºæ§åˆ¶ | GPIO 0 | å·¥ä½æ€»ç”µæºå¼€å…³ |
| ç¯å…‰æ§åˆ¶ | GPIO 2 | ç…§æ˜ç¯å¼€å…³ |
| 1å·ç»§ç”µå™¨ | GPIO 13 | æ‰©å±•è®¾å¤‡1 |
| 2å·ç»§ç”µå™¨ | GPIO 4 | æ‰©å±•è®¾å¤‡2 |

### RFIDè¯»å¡å™¨ï¼ˆRC522ï¼‰

| ä¿¡å· | ESP32å¼•è„š | è¯´æ˜ |
|-----|----------|-----|
| SPI MISO | GPIO 25 | SPIæ•°æ®è¾“å…¥ |
| SPI MOSI | GPIO 21 | SPIæ•°æ®è¾“å‡º |
| SPI SCLK | GPIO 22 | SPIæ—¶é’Ÿ |
| SPI CS | GPIO 5 | ç‰‡é€‰ä¿¡å· |
| RST | -1 | è½¯å¤ä½ï¼ˆä¸ä½¿ç”¨ç‰©ç†å¼•è„šï¼‰ |

### OLEDæ˜¾ç¤ºå±ï¼ˆSSD1306ï¼‰

| ä¿¡å· | ESP32å¼•è„š | è¯´æ˜ |
|-----|----------|-----|
| I2C SDA | GPIO 23 | I2Cæ•°æ®çº¿ |
| I2C SCL | GPIO 18 | I2Cæ—¶é’Ÿçº¿ |
| åœ°å€ | 0x3C | I2Cè®¾å¤‡åœ°å€ |

---

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### 1. RFIDé—¨ç¦æ§åˆ¶

- **åˆ·å¡ä¸Šç­**ï¼šå°†MIFAREå¡ç‰‡é è¿‘RC522è¯»å¡å™¨
  - è‡ªåŠ¨è¯»å–å¡ç‰‡Block 1çš„å‰10ä¸ªå­—ç¬¦ä½œä¸ºç”¨æˆ·ID
  - æ‰“å¼€æ‰€æœ‰ç»§ç”µå™¨ï¼ˆç”µæºã€ç¯å…‰ã€1å·ã€2å·ï¼‰
  - ç”¨æˆ·IDä¸Šä¼ è‡³MQTTæœåŠ¡å™¨

- **åˆ·å¡ä¸‹ç­**ï¼šç§»é™¤å¡ç‰‡
  - å…³é—­æ‰€æœ‰ç»§ç”µå™¨
  - ç”¨æˆ·IDè®¾ç½®ä¸º"null"å¹¶ä¸Šä¼ 

### 2. ç¯å¢ƒæ•°æ®é‡‡é›†

- **é‡‡æ ·å‘¨æœŸ**ï¼š5ç§’
- **ADCé…ç½®**ï¼š12ä½ç²¾åº¦ï¼Œ0-3.3Vé‡ç¨‹
- **æ•°æ®ç±»å‹**ï¼š
  - æ¸©åº¦ï¼šæ‘„æ°åº¦ï¼ˆâ„ƒï¼‰
  - æ¹¿åº¦ï¼šç™¾åˆ†æ¯”ï¼ˆ%ï¼‰
  - å…‰ç…§/çƒŸé›¾/ç«ç„°/çƒ­åº¦ï¼šç™¾åˆ†æ¯”ï¼ˆ0-100%ï¼‰

### 3. MQTTäº‘ç«¯é€šä¿¡ï¼ˆOneNetæ ‡å‡†ï¼‰

- **Brokeråœ°å€**ï¼š`mqtt://218.201.45.2:1883`
- **äº§å“ID**ï¼š`3HSBa0ZB1R`
- **è®¾å¤‡ID**ï¼š`ESP_01`

#### ğŸ“¤ å‘å¸ƒä¸»é¢˜ï¼ˆè®¾å¤‡â†’äº‘ç«¯ï¼‰
- **å±æ€§ä¸ŠæŠ¥**ï¼š`$sys/3HSBa0ZB1R/ESP_01/thing/property/post`
- **äº‹ä»¶ä¸ŠæŠ¥**ï¼š`$sys/3HSBa0ZB1R/ESP_01/thing/event/post`

#### ğŸ“¥ è®¢é˜…ä¸»é¢˜ï¼ˆäº‘ç«¯â†’è®¾å¤‡ï¼‰
- **å±æ€§è®¾ç½®**ï¼š`$sys/3HSBa0ZB1R/ESP_01/thing/property/set`
- **äº‹ä»¶å›å¤**ï¼š`$sys/3HSBa0ZB1R/ESP_01/thing/event/post/reply`

#### ğŸ¯ äº‹ä»¶ç±»å‹
- **AlertEmergency**ï¼šç´§æ€¥å‘Šè­¦ï¼ˆç«ç¾ã€çƒŸé›¾ã€é«˜æ¸©ç­‰ï¼‰
- **AlertWarning**ï¼šä¸€èˆ¬å‘Šè­¦ï¼ˆæ¸©åº¦è¶Šé™ç­‰ï¼‰
- **EmergencyPowerOff**ï¼šç´§æ€¥æ–­ç”µé€šçŸ¥

### 4. è¿œç¨‹æ§åˆ¶åŠŸèƒ½

- **äº‘ç«¯è¿œç¨‹æ§åˆ¶**ï¼šæ”¯æŒè¿œç¨‹å¼€å…³è®¾å¤‡å’Œç”µæº
- **æ™ºèƒ½ç”¨æˆ·åç®¡ç†**ï¼š
  - è¿œç¨‹å¼€å¯ç”µæºæ—¶ç”¨æˆ·åè®¾ä¸º"0000000001"ï¼ˆç®¡ç†å‘˜ï¼‰
  - è¿œç¨‹å…³é—­ç”µæºæ—¶ç”¨æˆ·åé‡ç½®ä¸º"null"
  - ç”¨æˆ·åˆ·å¡æ—¶ç”¨æˆ·åæ›´æ–°ä¸ºåˆ·å¡ç”¨æˆ·

### 5. æ— äººå€¼å®ˆç›‘æ§

- **åŸºç¡€ä¼ æ„Ÿå™¨ä¸ŠæŠ¥**ï¼šæœªåˆ·å¡æ—¶æ¯30ç§’ä¸ŠæŠ¥æ¸©æ¹¿åº¦ã€çƒŸé›¾æ•°æ®
- **å®Œæ•´æ•°æ®ä¸ŠæŠ¥**ï¼šåˆ·å¡æ—¶æ¯60ç§’ä¸ŠæŠ¥æ‰€æœ‰ä¼ æ„Ÿå™¨å’Œè®¾å¤‡çŠ¶æ€
- **æ™ºèƒ½åˆ‡æ¢**ï¼šåˆ·å¡åè‡ªåŠ¨åˆ‡æ¢åˆ°å®Œæ•´æ•°æ®ä¸ŠæŠ¥æ¨¡å¼

### 6. ç´§æ€¥æ–­ç”µä¿æŠ¤

- **è‡ªåŠ¨æ–­ç”µ**ï¼šä¼ æ„Ÿå™¨å¼‚å¸¸æ—¶è‡ªåŠ¨åˆ‡æ–­ç”µæº
- **äº‹ä»¶é€šçŸ¥**ï¼šå‘é€EmergencyPowerOffå’ŒAlertEmergencyäº‹ä»¶
- **å®‰å…¨æ¢å¤**ï¼šè¿œç¨‹æ¢å¤ä¾›ç”µæ—¶æ¸…é™¤ç´§æ€¥çŠ¶æ€æ ‡å¿—

### 7. WiFiè¿æ¥

- **æ¨¡å¼**ï¼šSTAï¼ˆStationï¼‰æ¨¡å¼
- **SSID**ï¼š`pc_lk`
- **å¯†ç **ï¼š`123456789`
- **è‡ªåŠ¨é‡è¿**ï¼šæ”¯æŒ

---

## ğŸ“Š æ•°æ®æ ¼å¼ï¼ˆOneNetæ ‡å‡†ï¼‰

### å±æ€§æ•°æ®JSONæ ¼å¼ï¼ˆå®Œæ•´ä¸ŠæŠ¥ï¼‰

```json
{
  "id": "123",
  "version": "1.0",
  "params": {
    "CurrentTemperature": {"value": 25.5},
    "FlameScope": {"value": 10.2},
    "HeatScope": {"value": 45.8},
    "LightLuxValue": {"value": 78.3},
    "LightStatus": {"value": 1},
    "PowerStatus": {"value": 1},
    "RelativeHumidity": {"value": 60.5},
    "RelayNum1Status": {"value": 1},
    "RelayNum2Status": {"value": 1},
    "SmokeScope": {"value": 5.2},
    "username": {"value": "ABC1234567"}
  }
}
```

### åŸºç¡€ä¼ æ„Ÿå™¨æ•°æ®JSONæ ¼å¼ï¼ˆæœªåˆ·å¡æ—¶ï¼‰

```json
{
  "id": "123",
  "version": "1.0",
  "params": {
    "CurrentTemperature": {"value": 25.5},
    "RelativeHumidity": {"value": 60.5},
    "SmokeScope": {"value": 5.2}
  }
}
```

### äº‹ä»¶æ•°æ®JSONæ ¼å¼ï¼ˆOneNetæ ‡å‡†ï¼‰

```json
{
  "id": "123",
  "version": "1.0",
  "params": {
    "AlertEmergency": {
      "value": {
        "alertType": "FIRE_EMERGENCY",
        "severity": "EMERGENCY",
        "sensorValue": 75.0,
        "threshold": 70.0,
        "timestamp": "2023-10-27T08:30:00Z",
        "username": "ABC1234567",
        "temperature": 25.5,
        "humidity": 60.5,
        "flameScope": 75.0,
        "smokeScope": 5.2
      }
    }
  }
}
```

### æ•°æ®å­—æ®µè¯´æ˜

#### å±æ€§å­—æ®µ
| å­—æ®µå | ç±»å‹ | å•ä½ | è¯´æ˜ |
|-------|------|-----|------|
| CurrentTemperature | float | â„ƒ | å½“å‰æ¸©åº¦ |
| RelativeHumidity | float | % | ç›¸å¯¹æ¹¿åº¦ |
| LightLuxValue | float | % | å…‰ç…§å¼ºåº¦ï¼ˆç™¾åˆ†æ¯”ï¼‰ |
| SmokeScope | float | % | çƒŸé›¾æµ“åº¦ |
| FlameScope | float | % | ç«ç„°å¼ºåº¦ |
| HeatScope | float | % | çƒ­åº¦ |
| PowerStatus | int | 0/1 | ç”µæºçŠ¶æ€ï¼ˆ0å…³/1å¼€ï¼‰ |
| LightStatus | int | 0/1 | ç¯å…‰çŠ¶æ€ |
| RelayNum1Status | int | 0/1 | 1å·ç»§ç”µå™¨çŠ¶æ€ |
| RelayNum2Status | int | 0/1 | 2å·ç»§ç”µå™¨çŠ¶æ€ |
| username | string | - | ç”¨æˆ·å |

#### äº‹ä»¶å­—æ®µ
| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|-------|------|------|
| alertType | string | å‘Šè­¦ç±»å‹ï¼ˆFIRE_EMERGENCYç­‰ï¼‰ |
| severity | string | ä¸¥é‡ç¨‹åº¦ï¼ˆEMERGENCY/WARNINGï¼‰ |
| sensorValue | float | è§¦å‘å‘Šè­¦çš„ä¼ æ„Ÿå™¨å€¼ |
| threshold | float | å‘Šè­¦é˜ˆå€¼ |
| timestamp | string | å‘Šè­¦æ—¶é—´ï¼ˆISO 8601æ ¼å¼ï¼‰ |
| username | string | è§¦å‘å‘Šè­¦çš„ç”¨æˆ· |
| temperature | float | å½“æ—¶æ¸©åº¦ |
| humidity | float | å½“æ—¶æ¹¿åº¦ |
| flameScope | float | å½“æ—¶ç«ç„°å¼ºåº¦ |
| smokeScope | float | å½“æ—¶çƒŸé›¾æµ“åº¦ |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- **ESP-IDFç‰ˆæœ¬**ï¼š>= 4.1.0
- **å·¥å…·é“¾**ï¼šESP-IDFå·¥å…·é“¾
- **Python**ï¼š>= 3.6

### å®‰è£…æ­¥éª¤

1. **å…‹éš†é¡¹ç›®**
   ```bash
   git clone <repository_url>
   cd test1_demo
   ```

2. **é…ç½®WiFiå’ŒMQTT**
   
   ä¿®æ”¹ `main/inc/config.h`ï¼š
   ```c
   #define ESP_WIFI_STA_SSID "your_wifi_ssid"
   #define ESP_WIFI_STA_PASSWD "your_wifi_password"
   ```
   
   ä¿®æ”¹ `main/main.c` ä¸­çš„MQTTé…ç½®ï¼ˆå¦‚éœ€æ›´æ”¹ï¼‰ã€‚

3. **ç¼–è¯‘é¡¹ç›®**
   ```bash
   idf.py build
   ```

4. **çƒ§å½•å›ºä»¶**
   ```bash
   idf.py -p COM3 flash
   ```
   > æ³¨ï¼šå°† `COM3` æ›¿æ¢ä¸ºä½ çš„ä¸²å£å·

5. **æŸ¥çœ‹æ—¥å¿—**
   ```bash
   idf.py -p COM3 monitor
   ```

---

## ğŸ“ ä½¿ç”¨è¯´æ˜

### RFIDå¡ç‰‡å‡†å¤‡

1. **å¡ç‰‡ç±»å‹**ï¼šMIFARE Classic 1K/4K æˆ–å…¼å®¹å¡ç‰‡
2. **å†™å…¥ç”¨æˆ·ID**ï¼š
   - ä½¿ç”¨NFCè¯»å†™å·¥å…·
   - åœ¨å¡ç‰‡çš„**Block 1**å†™å…¥ç”¨æˆ·IDï¼ˆ10ä¸ªå­—ç¬¦ï¼‰
   - ä¾‹å¦‚ï¼š`USER123456`ï¼ˆä¸è¶³10ä½ä¼šè‡ªåŠ¨è¡¥é½ï¼‰
3. **è®¤è¯å¯†é’¥**ï¼šä½¿ç”¨é»˜è®¤å¯†é’¥ `FF FF FF FF FF FF`

### ç³»ç»Ÿå¯åŠ¨æµç¨‹

1. ä¸Šç”µåè‡ªåŠ¨åˆå§‹åŒ–æ‰€æœ‰å¤–è®¾
2. è¿æ¥WiFiçƒ­ç‚¹
3. è¿æ¥MQTTæœåŠ¡å™¨å¹¶è®¢é˜…æ§åˆ¶ä¸»é¢˜
4. åˆå§‹åŒ–RC522è¯»å¡å™¨
5. å¼€å§‹ä¼ æ„Ÿå™¨æ•°æ®é‡‡é›†ï¼ˆ5ç§’å‘¨æœŸï¼‰

### å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç³»ç»Ÿå¯åŠ¨ â†’ WiFiè¿æ¥ â†’ MQTTè¿æ¥ â†’ RC522åˆå§‹åŒ–     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚   æœªåˆ·å¡ï¼ˆåˆå§‹çŠ¶æ€ï¼‰      â”‚
             â”‚  â€¢ æ‰€æœ‰è®¾å¤‡å…³é—­           â”‚
             â”‚  â€¢ username = "null"     â”‚
             â”‚  â€¢ 30ç§’ä¸ŠæŠ¥æ¸©æ¹¿åº¦å’ŒçƒŸé›¾    â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     ã€åˆ·å¡é è¿‘ã€‘     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è¿œç¨‹æ§åˆ¶   â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚   ç”¨æˆ·åˆ·å¡   â”‚
â”‚ â€¢ å¯è¿œç¨‹å¼€å…³è®¾å¤‡ â”‚                 â”‚ â€¢ usernameæ›´æ–° â”‚
â”‚ â€¢ ç®¡ç†å‘˜ç”¨æˆ·åç®¡ç† â”‚                 â”‚ â€¢ è®¾å¤‡è‡ªåŠ¨å¼€å¯ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚    æ­£å¸¸å·¥ä½œçŠ¶æ€         â”‚
             â”‚  â€¢ æ¯60ç§’é‡‡é›†æ‰€æœ‰ä¼ æ„Ÿå™¨   â”‚
             â”‚  â€¢ MQTTä¸Šä¼ å®Œæ•´æ•°æ®      â”‚
             â”‚  â€¢ è‡ªåŠ¨æ§åˆ¶åŠŸèƒ½å¯ç”¨       â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
              ã€ä¼ æ„Ÿå™¨å¼‚å¸¸ã€‘          ã€ç§»é™¤å¡ç‰‡ã€‘
                    â†“                       â†“
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚ ç´§æ€¥æ–­ç”µä¿æŠ¤  â”‚     â”‚ ä¸‹ç­ç¦»å¼€      â”‚
             â”‚ â€¢ è‡ªåŠ¨åˆ‡æ–­ç”µæº â”‚     â”‚ â€¢ å…³é—­æ‰€æœ‰è®¾å¤‡ â”‚
             â”‚ â€¢ å‘é€ç´§æ€¥äº‹ä»¶ â”‚     â”‚ â€¢ username=null â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—‚ï¸ é¡¹ç›®ç»“æ„

```
test1_demo/
â”œâ”€â”€ main/
â”‚   â”œâ”€â”€ main.c                 # ä¸»ç¨‹åºï¼ˆæ–°å¢è¿œç¨‹æ§åˆ¶ã€æ— äººå€¼å®ˆç›‘æ§ï¼‰
â”‚   â”œâ”€â”€ headfile.h             # å¤´æ–‡ä»¶æ±‡æ€»
â”‚   â”œâ”€â”€ inc/
â”‚   â”‚   â”œâ”€â”€ config.h           # é…ç½®æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ rtos_task.h        # RTOSä»»åŠ¡å®šä¹‰
â”‚   â”‚   â””â”€â”€ icon_codeing.h     # OLEDå›¾æ ‡ç¼–ç 
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ config.c           # é…ç½®å®ç°
â”‚       â””â”€â”€ rtos_task.c        # RTOSä»»åŠ¡å®ç°
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ led/                   # LEDæ§åˆ¶ç»„ä»¶
â”‚   â””â”€â”€ key/                   # æŒ‰é”®é©±åŠ¨ç»„ä»¶
â”œâ”€â”€ managed_components/        # ESPç»„ä»¶ç®¡ç†å™¨ä¾èµ–
â”‚   â”œâ”€â”€ abobija__rc522/        # RC522 RFIDé©±åŠ¨
â”‚   â”œâ”€â”€ espressif__ssd1306/    # OLEDæ˜¾ç¤ºé©±åŠ¨
â”‚   â”œâ”€â”€ esp-idf-lib__dht/      # DHT11æ¸©æ¹¿åº¦é©±åŠ¨
â”‚   â””â”€â”€ ...
â”œâ”€â”€ ONENET_TOPIC_GUIDE.md      # ğŸ“„ OneNetä¸»é¢˜ä½¿ç”¨æŒ‡å—ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ EDGE_DETECTION_README.md   # ğŸ“„ è¾¹ç¼˜æ£€æµ‹ç³»ç»Ÿè¯´æ˜ï¼ˆå·²æ›´æ–°ï¼‰
â”œâ”€â”€ BACKEND_INTEGRATION_EXAMPLE.md # ğŸ“„ åç«¯é›†æˆç¤ºä¾‹ï¼ˆå·²æ›´æ–°ï¼‰
â”œâ”€â”€ CHANGES_SUMMARY.md         # ğŸ“„ æ›´æ–°æ‘˜è¦ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ CMakeLists.txt             # CMakeé…ç½®
â”œâ”€â”€ sdkconfig                  # ESP-IDFé…ç½®
â””â”€â”€ README.md                  # æœ¬æ–‡ä»¶ï¼ˆå·²æ›´æ–°ï¼‰
```

---

## ğŸ“¦ ä¾èµ–ç»„ä»¶

æœ¬é¡¹ç›®ä½¿ç”¨ESP-IDFç»„ä»¶ç®¡ç†å™¨ç®¡ç†ä»¥ä¸‹ä¾èµ–ï¼š

```yaml
dependencies:
  idf: ">=4.1.0"
  espressif/ds18b20: "^0.2.0"
  espressif/led_strip: "^3.0.1~1"
  espressif/ssd1306: "^1.0.5~1"
  esp-idf-lib/dht: "^1.1.7"
  espp/adc: "^1.0.25"
  abobija/rc522: "^3.4.3"
  espressif/onewire_bus: "^2.0.0"    # æ–°å¢ï¼šOneWireæ€»çº¿æ”¯æŒ
  espressif/led_strip: "^3.0.1~1"   # LEDç¯å¸¦æ§åˆ¶
  espp/format: "^1.0.0"             # æ–°å¢ï¼šæ ¼å¼åŒ–è¾“å‡ºæ”¯æŒ
  espp/logger: "^1.0.0"             # æ–°å¢ï¼šæ—¥å¿—ç³»ç»Ÿå¢å¼º
  espp/task: "^1.0.0"               # æ–°å¢ï¼šä»»åŠ¡ç®¡ç†å¢å¼º
```

## ğŸ“‹ æ–°å¢ç‰¹æ€§è¯´æ˜

### ğŸŒ OneNetæ ‡å‡†å…¼å®¹
- **å®Œå…¨å…¼å®¹OneNetç‰©æ¨¡å‹æ ‡å‡†**
- **æ”¯æŒOneNetè§„åˆ™å¼•æ“**
- **å¯åœ¨OneNetæ§åˆ¶å°ç›´æ¥è°ƒè¯•**

### ğŸ“¡ è¿œç¨‹æ§åˆ¶åŠŸèƒ½
- **äº‘ç«¯è¿œç¨‹å¼€å…³è®¾å¤‡**
- **æ™ºèƒ½ç”¨æˆ·åç®¡ç†**
- **è¿œç¨‹ç´§æ€¥æ–­ç”µæ¢å¤**

### ğŸ“Š æ— äººå€¼å®ˆç›‘æ§
- **æœªåˆ·å¡æ—¶å®šæœŸä¸ŠæŠ¥åŸºç¡€æ•°æ®**
- **æ™ºèƒ½åˆ‡æ¢ä¸ŠæŠ¥é¢‘ç‡**
- **èµ„æºèŠ‚çº¦å‹ç›‘æ§**

### ğŸš¨ ç´§æ€¥ä¿æŠ¤ç³»ç»Ÿ
- **å¤šä¼ æ„Ÿå™¨å¼‚å¸¸æ£€æµ‹**
- **è‡ªåŠ¨æ–­ç”µä¿æŠ¤**
- **åŒé‡äº‹ä»¶é€šçŸ¥æœºåˆ¶**

---

## âš™ï¸ é…ç½®è¯´æ˜

### WiFié…ç½®

åœ¨ `main/inc/config.h` ä¸­ä¿®æ”¹ï¼š

```c
#define ESP_WIFI_STA_SSID "your_ssid"       // WiFiåç§°
#define ESP_WIFI_STA_PASSWD "your_password" // WiFiå¯†ç 
```

### MQTTé…ç½®

åœ¨ `main/main.c` çš„ `mqtt_app_init()` å‡½æ•°ä¸­ä¿®æ”¹ï¼š

```c
esp_mqtt_client_config_t mqtt_cfg = {
    .broker.address.uri = "mqtt://your_broker:1883",
    .credentials.username = "your_username",
    .credentials.client_id = "your_client_id",
    .credentials.authentication.password = "your_password"
};
```

### RC522å¼•è„šé…ç½®

åœ¨ `main/main.c` ä¸­ä¿®æ”¹ï¼š

```c
#define RC522_SPI_BUS_GPIO_MISO 25
#define RC522_SPI_BUS_GPIO_MOSI 21
#define RC522_SPI_BUS_GPIO_SCLK 22
#define RC522_SPI_SCANNER_GPIO_SDA 5
#define RC522_SCANNER_GPIO_RST -1  // -1è¡¨ç¤ºè½¯å¤ä½
```

### æ–°åŠŸèƒ½é…ç½®

#### è¿œç¨‹æ§åˆ¶åŠŸèƒ½
- **è‡ªåŠ¨å¯ç”¨**ï¼šè¿œç¨‹æ§åˆ¶æŒ‡ä»¤è‡ªåŠ¨è§£æå¹¶æ‰§è¡Œ
- **æƒé™ç®¡ç†**ï¼šè¿œç¨‹å¼€å¯ç”µæºæ—¶è‡ªåŠ¨è®¾ä¸ºç®¡ç†å‘˜èº«ä»½
- **çŠ¶æ€åŒæ­¥**ï¼šè¿œç¨‹æ“ä½œåçŠ¶æ€å˜é‡è‡ªåŠ¨æ›´æ–°

#### æ— äººå€¼å®ˆç›‘æ§
- **åŸºç¡€ä¸ŠæŠ¥é—´éš”**ï¼š30ç§’ï¼ˆæœªåˆ·å¡æ—¶ï¼‰
- **å®Œæ•´ä¸ŠæŠ¥é—´éš”**ï¼š60ç§’ï¼ˆåˆ·å¡æ—¶ï¼‰
- **è‡ªåŠ¨åˆ‡æ¢**ï¼šåˆ·å¡åè‡ªåŠ¨åˆ‡æ¢åˆ°å®Œæ•´æ•°æ®ä¸ŠæŠ¥æ¨¡å¼

#### ç´§æ€¥æ–­ç”µä¿æŠ¤
- **è‡ªåŠ¨æ£€æµ‹**ï¼šå¤šä¼ æ„Ÿå™¨å¼‚å¸¸è‡ªåŠ¨è§¦å‘
- **åŒé‡é€šçŸ¥**ï¼šåŒæ—¶å‘é€EmergencyPowerOffå’ŒAlertEmergencyäº‹ä»¶
- **å®‰å…¨æ¢å¤**ï¼šè¿œç¨‹æ¢å¤ä¾›ç”µæ—¶è‡ªåŠ¨æ¸…é™¤ç´§æ€¥çŠ¶æ€

---

## ğŸ› è°ƒè¯•è¯´æ˜

### æŸ¥çœ‹æ—¥å¿—

ç³»ç»Ÿæ—¥å¿—åŒ…å«ä»¥ä¸‹æ ‡ç­¾ï¼š

- **WIFI**ï¼šWiFiè¿æ¥çŠ¶æ€
- **MQTT**ï¼šMQTTé€šä¿¡æ—¥å¿—ï¼ˆå«è¿œç¨‹æ§åˆ¶ï¼‰
- **ENV**ï¼šç¯å¢ƒä¼ æ„Ÿå™¨æ•°æ®
- **RC522**ï¼šRFIDè¯»å¡æ—¥å¿—
- **ALERT**ï¼šè‡ªåŠ¨æ§åˆ¶å’Œå‘Šè­¦æ—¥å¿—

### æ­£å¸¸è¿è¡Œæ—¥å¿—ç¤ºä¾‹

```
I (1234) WIFI: Successfully connected to ap SSID:pc_lk
I (1235) WIFI: Obtained IP address: 192.168.1.100
I (2000) MQTT: MQTT_EVENT_CONNECTED
I (2001) RC522: RC522 RFID reader initialized successfully
I (2002) MQTT: Subscribed to property set, msg_id=...
I (2003) MQTT: [OK] MQTT fully connected and subscribed to all topics
I (5000) ENV: æ¸©æ¹¿åº¦ï¼šæ¹¿åº¦ 60.5% | æ¸©åº¦ 25.50â„ƒ | ç«ç„° 10 | å…‰ç…§ 78 | çƒŸé›¾ 5 | çƒ­åº¦ 45
I (5030) ALERT: Basic sensor upload (30s timer, no card)
I (5100) RC522: Card detected! User ID from Block 1: USER123456
I (5101) MQTT: Remote power on by administrator: 0000000001
I (5102) RC522: Power and relays turned ON
I (5200) MQTT: Generated JSON: {"id":"123",...}
```

### è¿œç¨‹æ§åˆ¶æ—¥å¿—ç¤ºä¾‹

```
I (MQTT) Processing remote control command
I (MQTT) Received command: {"LightStatus":1,"PowerStatus":1,"RelayNum1Status":1}
I (MQTT) Setting light status to: 1
I (MQTT) Setting power status to: 1
I (MQTT) Setting relay1 status to: 1
I (MQTT) Remote control command processed successfully
```

### è‡ªåŠ¨æ§åˆ¶æ—¥å¿—ç¤ºä¾‹

```
I (ALERT) Auto control check - Power: 1, Emergency: 0, Light: 15.0%, Smoke: 45.0%
I (ALERT) Auto light control: ON (Light intensity: 15.0%, threshold: 30.0%)
I (ALERT) Auto relay1 control: OFF (Smoke intensity: 45.0%, threshold: 50.0%)
```

### ç´§æ€¥æ–­ç”µæ—¥å¿—ç¤ºä¾‹

```
I (ALERT) [SMOKE EMERGENCY] Smoke: 75.0% (Threshold: 95.0%)
I (ALERT) Auto power-off triggered by smoke emergency!
I (ALERT) EMERGENCY POWER OFF TRIGGERED!
I (MQTT) Sending EmergencyPowerOff event to OneNet
I (MQTT) Sending AlertEmergency event to OneNet
I (ALERT) [EMERGENCY MODE] Device powered off for safety!
```

### å¸¸è§é—®é¢˜

**Q1: RC522æ— æ³•è¯»å–å¡ç‰‡**
- æ£€æŸ¥SPIå¼•è„šè¿æ¥æ˜¯å¦æ­£ç¡®
- ç¡®è®¤å¡ç‰‡ç±»å‹ä¸ºMIFARE Classic
- æ£€æŸ¥å¡ç‰‡æ˜¯å¦ä½¿ç”¨é»˜è®¤å¯†é’¥ï¼ˆFF FF FF FF FF FFï¼‰

**Q2: MQTTæ— æ³•è¿æ¥**
- æ£€æŸ¥WiFiæ˜¯å¦è¿æ¥æˆåŠŸ
- ç¡®è®¤MQTTæœåŠ¡å™¨åœ°å€å’Œç«¯å£æ­£ç¡®
- æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç æ˜¯å¦æ­£ç¡®

**Q3: ä¼ æ„Ÿå™¨æ•°æ®å¼‚å¸¸**
- æ£€æŸ¥ä¼ æ„Ÿå™¨ä¾›ç”µæ˜¯å¦æ­£å¸¸ï¼ˆ3.3Vï¼‰
- ç¡®è®¤GPIOå¼•è„šè¿æ¥æ­£ç¡®
- DHT11éœ€è¦ä¸Šæ‹‰ç”µé˜»

**Q4: è¿œç¨‹æ§åˆ¶ä¸å·¥ä½œ**
- ç¡®è®¤è®¾å¤‡å·²è®¢é˜…`thing/property/set`ä¸»é¢˜
- æ£€æŸ¥JSONæ ¼å¼æ˜¯å¦æ­£ç¡®ï¼š`{"PowerStatus":1,"LightStatus":1}`
- æŸ¥çœ‹MQTTæ—¥å¿—ï¼Œç¡®è®¤æ”¶åˆ°è¿œç¨‹æŒ‡ä»¤

**Q5: æœªåˆ·å¡æ—¶çœ‹ä¸åˆ°ä¼ æ„Ÿå™¨æ•°æ®**
- æœªåˆ·å¡æ—¶åªä¸ŠæŠ¥æ¸©æ¹¿åº¦å’ŒçƒŸé›¾æ•°æ®ï¼ˆ30ç§’é—´éš”ï¼‰
- æŸ¥çœ‹æ—¥å¿—ä¸­çš„"Basic sensor upload"æ¶ˆæ¯
- åœ¨OneNetæ§åˆ¶å°æŸ¥çœ‹åŸºç¡€ä¼ æ„Ÿå™¨æ•°æ®ä¸ŠæŠ¥

**Q6: ç´§æ€¥æ–­ç”µåæ— æ³•è¿œç¨‹æ¢å¤**
- æ£€æŸ¥ç´§æ€¥æ¨¡å¼æ˜¯å¦å·²æ¸…é™¤
- ç¡®è®¤è¿œç¨‹æŒ‡ä»¤ä¸­çš„ç”¨æˆ·åå¤„ç†é€»è¾‘
- æŸ¥çœ‹MQTTæ—¥å¿—ä¸­çš„è¿œç¨‹æ§åˆ¶å¤„ç†ä¿¡æ¯

**Q7: è‡ªåŠ¨æ§åˆ¶ä¸å·¥ä½œ**
- ç¡®è®¤ç”µæºå·²å¼€å¯ï¼ˆPowerStatus=1ï¼‰
- æ£€æŸ¥ç´§æ€¥æ¨¡å¼æ ‡å¿—ï¼ˆEmergency=0ï¼‰
- æŸ¥çœ‹ALERTæ—¥å¿—ä¸­çš„è‡ªåŠ¨æ§åˆ¶æ£€æŸ¥ä¿¡æ¯

---

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ã€‚

---

## ğŸ‘¨â€ğŸ’» ä½œè€…

ESP32æ™ºèƒ½å·¥ä½ç›‘æ§ç³»ç»Ÿ

---

## ğŸ”— ç›¸å…³èµ„æº

- [ESP-IDFç¼–ç¨‹æŒ‡å—](https://docs.espressif.com/projects/esp-idf/zh_CN/latest/)
- [RC522ç»„ä»¶æ–‡æ¡£](https://components.espressif.com/components/abobija/rc522)
- [DHTä¼ æ„Ÿå™¨åº“](https://github.com/UncleRus/esp-idf-lib)
- [SSD1306æ˜¾ç¤ºé©±åŠ¨](https://components.espressif.com/components/espressif/ssd1306)
- [OneNetç‰©è”ç½‘å¹³å°](https://open.iot.10086.cn/)
- [OneNetç‰©æ¨¡å‹æ–‡æ¡£](https://open.iot.10086.cn/doc/art396.html)

## ğŸ“š é¡¹ç›®æ–‡æ¡£

- ğŸ“„ `ONENET_TOPIC_GUIDE.md` - OneNetä¸»é¢˜ä½¿ç”¨æŒ‡å—
- ğŸ“„ `EDGE_DETECTION_README.md` - è¾¹ç¼˜æ£€æµ‹ç³»ç»Ÿè¯´æ˜
- ğŸ“„ `QUICK_START_GUIDE.md` - å¿«é€Ÿä¸Šæ‰‹æŒ‡å—
- ğŸ“„ `BACKEND_INTEGRATION_EXAMPLE.md` - åç«¯é›†æˆç¤ºä¾‹
- ğŸ“„ `CHANGES_SUMMARY.md` - æ›´æ–°æ‘˜è¦

---

## ğŸ“® åé¦ˆä¸æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿æäº¤Issueæˆ–Pull Requestã€‚

---

**æ›´æ–°æ—¥æœŸ**ï¼š2025-01-XX

---
*æœ€æ–°æ›´æ–°ï¼šå®Œå…¨å…¼å®¹OneNetç‰©æ¨¡å‹æ ‡å‡†ï¼Œæ–°å¢è¿œç¨‹æ§åˆ¶ã€æ— äººå€¼å®ˆç›‘æ§ã€ç´§æ€¥æ–­ç”µä¿æŠ¤ç­‰åŠŸèƒ½*
